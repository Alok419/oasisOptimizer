<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Non-OASIS Analyzer (Unified)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        /* --- VARIABLES (Light Theme) --- */
        :root {
            --bg-body: #ffffff;
            --card-bg: #ffffff;
            --card-border: 1px solid #e2e8f0;
            --primary: #3b82f6;
            --success: #10b981;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --font-ui: 'Poppins', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }

        /* --- GLOBAL LAYOUT --- */
        body {
            background-color: #FAFAFA;
            font-family: var(--font-ui);
            color: var(--text-main);
            min-height: 100vh;
        }

        /* --- MAIN CARD --- */
        .card-custom {
            width: 100%;
            max-width: 1150px;
            background: var(--card-bg);
            border: var(--card-border);
            border-radius: 28px;
            padding: 40px;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.04);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .section-container {
            background: #ffffff;
            border-radius: 20px;
            padding: 24px;
            border: 1px solid #f1f5f9;
            margin-bottom: 24px;
        }

        @media (max-width: 768px) {
            body {
                padding: 20px 10px;
            }

            .card-custom {
                padding: 20px;
                border-radius: 16px;
            }

            .fs-2 {
                font-size: 1.5rem !important;
            }

            .fs-6 {
                font-size: 0.875rem !important;
            }
        }

        /* --- CUSTOM INPUTS --- */
        .custom-input {
            border-radius: 12px !important;
            border: 1px solid #e2e8f0 !important;
            background-color: #ffffff !important;
            padding: 12px 16px !important;
            font-size: 0.95rem !important;
            color: #1e293b !important;
            transition: all 0.2s ease;
        }

        .custom-input:focus {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
            outline: none;
        }

        .custom-input::placeholder {
            color: #94a3b8 !important;
            font-weight: 400;
        }

        .custom-label {
            font-weight: 500;
            color: #1e293b;
            margin-bottom: 8px;
            font-size: 0.9rem;
            display: block;
        }

        .input-icon-wrapper {
            position: relative;
        }

        .input-icon-wrapper i {
            position: absolute;
            right: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            font-size: 1.1rem;
            pointer-events: none;
        }



        /* Loading Pulse */
        #loadingMessage {
            text-align: center;
            color: var(--primary);
            margin-bottom: 20px;
            font-weight: 600;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* --- UPLOAD SECTION --- */
        .upload-card {
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 25px;
            transition: transform 0.2s ease, border-color 0.2s;
        }

        .upload-header {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            align-items: center;
        }

        .upload-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: rgba(59, 130, 246, 0.15);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.1);
        }

        .upload-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-main);
        }

        .upload-subtitle {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Drop Zone */
        .upload-zone {
            border: 2px dashed rgba(148, 163, 184, 0.3);
            border-radius: 12px;
            padding: 35px;
            text-align: center;
            background: rgba(15, 23, 42, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .upload-zone:hover {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.05);
            transform: translateY(-2px);
        }

        .upload-zone-icon {
            font-size: 32px;
            color: var(--text-muted);
            margin-bottom: 10px;
            transition: color 0.3s;
        }

        .upload-zone:hover .upload-zone-icon {
            color: var(--primary);
        }

        .upload-zone-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-muted);
        }

        /* --- FILE LIST --- */
        .file-section-header {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            color: var(--text-muted);
            margin-bottom: 12px;
            display: none;
            /* Controlled by JS */
        }

        .file-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 10px;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }

        .file-item:hover {
            background: rgba(40, 50, 70, 0.9);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .file-left {
            display: flex;
            align-items: center;
            gap: 14px;
            overflow: hidden;
        }

        .file-type-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: #0f172a;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .file-meta {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .file-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-size {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .remove-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-btn:hover {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        /* --- BUTTONS --- */
        .analyze-btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            font-size: 15px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
            letter-spacing: 0.02em;
        }

        .analyze-btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
        }

        .analyze-btn:active {
            transform: translateY(0);
        }

        .analyze-btn:disabled {
            background: #334155;
            color: #94a3b8;
            box-shadow: none;
            cursor: not-allowed;
        }

        .save-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 15px;
            margin-top: 20px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .save-btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .save-btn:disabled {
            background: #334155;
            color: #94a3b8;
            box-shadow: none;
            cursor: not-allowed;
        }

        /* --- PROGRESS UI (STEPPER) --- */
        .progress-wrapper {
            display: none;
            /* JS toggles this */
            background: #ffffff;
            border-radius: 24px;
            padding: 40px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
            position: relative;
            overflow: hidden;
            text-align: left;
        }

        .stepper-header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .stepper-icon-main {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
            color: white;
            font-size: 1.8rem;
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.25);
        }

        .btn-close-stop {
            position: absolute;
            right: 10px;
            top: 10px;
            border: 1px solid #e2e8f0;
            background: #ffffff;
            padding: 8px 16px;
            border-radius: 10px;
            font-size: 0.85rem;
            color: #475569;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .btn-close-stop:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        .stepper-list {
            position: relative;
            padding-left: 80px;
        }

        .stepper-line {
            position: absolute;
            left: 39px;
            top: 10px;
            bottom: 40px;
            width: 2px;
            background: #f1f5f9;
            z-index: 1;
        }

        .stepper-item {
            position: relative;
            margin-bottom: 32px;
            z-index: 2;
            opacity: 0.5;
            transition: all 0.3s;
        }

        .stepper-item.completed,
        .stepper-item.active {
            opacity: 1;
        }

        .stepper-indicator {
            position: absolute;
            left: -56px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: white;
            border: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
            color: #94a3b8;
            transition: all 0.3s;
        }

        .stepper-item.completed .stepper-indicator {
            background: #22c55e;
            border-color: #22c55e;
            color: white;
        }

        .stepper-item.active .stepper-indicator {
            background: #ffffff;
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .stepper-content h6 {
            margin-bottom: 2px;
            font-size: 0.95rem;
            color: #64748b;
            transition: color 0.3s;
        }

        .stepper-item.active h6 {
            color: #3b82f6;
        }

        .stepper-item.completed h6 {
            color: #1e293b;
        }

        .stepper-content p {
            margin-bottom: 0;
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .stepper-item.completed p {
            color: #64748b;
        }

        .spinner-stepper {
            display: inline-block;
            width: 0.9rem;
            height: 0.9rem;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
            vertical-align: middle;
            margin-left: 8px;
        }

        .progress-bar-minimal {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 5px;
            background: linear-gradient(90deg, #3b82f6, #6366f1);
            transition: width 0.3s ease;
            box-shadow: 0 -2px 10px rgba(59, 130, 246, 0.2);
        }

        /* --- FEATURE CARDS --- */
        .feature-card-custom {
            background: #ffffff;
            border: 1px solid #f1f5f9;
            border-radius: 20px;
            padding: 32px 24px;
            height: 100%;
            transition: all 0.3s ease;
        }

        .feature-card-custom:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px -10px rgba(0, 0, 0, 0.08);
            border-color: #e2e8f0;
        }

        /* --- BUTTON GLOW --- */
        #analyzeBtn:not(:disabled):hover {
            opacity: 0.95;
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(34, 211, 238, 0.4);
        }

        #analyzeBtn {
            transition: all 0.2s ease;
        }

        /* --- RESULTS AREA (REPORT UI) --- */
        #resultArea {
            width: 100%;
            max-width: 1150px;
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .report-section-header {
            padding: 12px 24px;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .bg-report-blue {
            background: #0070D2;
        }

        .bg-report-dark {
            background: #1e293b;
        }

        .stats-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 50px;
        }

        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
        }

        .processed-doc-item {
            background: #f8fafc;
            border: 1px solid #f1f5f9;
            border-radius: 12px;
            padding: 12px 20px;
            transition: all 0.2s ease;
        }

        .processed-doc-item:hover {
            border-color: #e2e8f0;
            background: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
        }

        .btn-report-action {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-report-action:hover {
            transform: translateY(-1px);
        }

        /* --- STATUS MESSAGES --- */
        .status {
            margin-top: 20px;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            min-height: 24px;
        }

        .success {
            color: var(--success);
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
        }

        .error {
            color: var(--danger);
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
        }

        /* --- DISABLED STATES --- */
        .upload-disabled {
            pointer-events: none;
            opacity: 0.5;
            filter: grayscale(0.5);
        }

        .upload-disabled * {
            cursor: wait !important;
        }
    </style>
</head>

<body>
    <div class="container py-5">
        <div class="mb-4 text-center">
            <h2 class="fs-1 fw-semibold text-dark">AI Non-OASIS Analyzer</h2>
            <p class="fs-6 fw-normal text-dark">Upload OASIS document(s) to extract data</p>
        </div>

        <div class="d-flex justify-content-center">
            <div>
                <div>


                    <div id="loadingMessage"
                        style="text-align:center; color:#4fa3ff; margin-bottom:15px; font-weight:500; display:none;">
                        Connecting to Salesforce...
                    </div>

                    <div id="mainControls" style="display:block;">
                        <!-- Patient Information -->
                        <div class="section-container">
                            <div class="d-flex align-items-center mb-4">
                                <div class="d-flex align-items-center justify-content-center bg-success bg-opacity-10 text-success rounded-3 me-3"
                                    style="width: 48px; height: 48px;">
                                    <i class="bi bi-file-earmark-person fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="mb-1 fw-bold text-dark">Patient Information</h5>
                                    <div class="text-secondary small">Enter patient details for analysis</div>
                                </div>
                            </div>
                            <div class="row g-4">
                                <div class="col-md-4">
                                    <label class="custom-label">Last Name</label>
                                    <input type="text" class="form-control custom-input" placeholder="Enter last name"
                                        id="lastName">
                                </div>
                                <div class="col-md-4">
                                    <label class="custom-label">First Name</label>
                                    <input type="text" class="form-control custom-input" placeholder="Enter first name"
                                        id="firstName">
                                </div>
                                <div class="col-md-4">
                                    <label class="custom-label">Visit Date</label>
                                    <div class="input-icon-wrapper">
                                        <input type="date" class="form-control custom-input w-100" id="visitDate">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Upload OASIS Documents -->
                        <div class="section-container mb-4">
                            <div class="d-flex align-items-center mb-4">
                                <div class="d-flex align-items-center justify-content-center bg-primary bg-opacity-10 text-primary rounded-3 me-3"
                                    style="width: 48px; height: 48px;">
                                    <i class="bi bi-file-earmark-text fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="mb-1 fw-bold text-dark">Upload OASIS Documents</h5>
                                    <div class="text-secondary small">Select or drag & drop patient assessment files
                                    </div>
                                </div>
                            </div>

                            <div class="rounded-4 border-2 border-dashed p-5 text-center position-relative mb-3"
                                style="border: 2px dashed #cbd5e1; background: #fdfdfd; cursor: pointer; transition: all 0.2s;"
                                onclick="document.getElementById('fileInput').click()"
                                onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#f8fafc';"
                                onmouseout="this.style.borderColor='#cbd5e1'; this.style.background='#fdfdfd';">

                                <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" multiple
                                    hidden onchange="handleFileSelect(this)">

                                <div class="mb-3">
                                    <div class="d-inline-flex align-items-center justify-content-center p-3 rounded-circle shadow-lg"
                                        style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); width: 64px; height: 64px;">
                                        <i class="bi bi-cloud-arrow-up text-white fs-3"></i>
                                    </div>
                                </div>
                                <div class="text-dark fw-semibold fs-5 mb-1">Click to upload or drag files here</div>
                                <div class="text-secondary small">Support PDF, Images, and Word documents</div>
                            </div>

                            <div id="fileSectionHeader" class="text-uppercase fw-bold text-muted mb-2 small"
                                style="display:none; letter-spacing: 0.5px;">
                                Uploaded Files (<span id="fileCount">0</span>)
                            </div>
                            <div id="fileListContainer" class="d-flex flex-column gap-2"></div>
                        </div>

                        <button id="analyzeBtn" class="btn btn-lg w-100 py-2 text-white fw-bold border-0 shadow-lg mb-2"
                            onclick="startAnalysis()" disabled
                            style="background: linear-gradient(90deg, #06b6d4 0%, #3b82f6 100%); border-radius: 14px;">
                            Analyze with AI
                        </button>
                    </div>
                    <!-- Feature Cards Section -->
                    <div id="featureCards" class="row g-4 mt-2">
                        <div class="col-md-4">
                            <div class="feature-card-custom text-center">
                                <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-4"
                                    style="width: 64px; height: 64px; background-color: #f5f3ff;">
                                    <i class="bi bi-stars" style="color: #a855f7; font-size: 1.6rem;"></i>
                                </div>
                                <h6 class="fw-semibold text-dark mb-2" style="font-size: 1.25rem;">Smart Extraction</h6>
                                <p class="text-secondary small mb-0 px-2" style="font-size: 0.95rem; line-height: 1.6;">
                                    AI-powered data extraction from OASIS documents with context awareness.</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="feature-card-custom text-center">
                                <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-4"
                                    style="width: 64px; height: 64px; background-color: #eff6ff;">
                                    <i class="bi bi-check2-circle" style="color: #3b82f6; font-size: 1.6rem;"></i>
                                </div>
                                <h6 class="fw-semibold text-dark mb-2" style="font-size: 1.25rem;">Accurate Analysis
                                </h6>
                                <p class="text-secondary small mb-0 px-2" style="font-size: 0.95rem; line-height: 1.6;">
                                    Verified medical coding algorithms with 99.8% validation accuracy.</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="feature-card-custom text-center">
                                <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-4"
                                    style="width: 64px; height: 64px; background-color: #f0fdf4;">
                                    <i class="bi bi-lightning-charge" style="color: #22c55e; font-size: 1.6rem;"></i>
                                </div>
                                <h6 class="fw-semibold text-dark mb-2" style="font-size: 1.25rem;">Fast Processing</h6>
                                <p class="text-secondary small mb-0 px-2" style="font-size: 0.95rem; line-height: 1.6;">
                                    Average processing time under 45 seconds for multiple records.</p>
                            </div>
                        </div>
                    </div>

                    <div id="progressWrapper" class="progress-wrapper">
                        <div class="stepper-header">
                            <div class="stepper-icon-main">
                                <i class="bi bi-stars"></i>
                            </div>
                            <h2 class="fw-bold text-dark mb-1">Analyzing Documents</h2>
                            <p class="text-secondary small">AI is processing your OASIS documents...</p>
                            <button class="btn-close-stop" onclick="location.reload()">
                                <i class="bi bi-x-lg me-1"></i> Close & Stop
                            </button>
                        </div>

                        <div class="stepper-list">
                            <div class="stepper-line"></div>

                            <!-- Step 1 -->
                            <div class="stepper-item completed">
                                <div class="stepper-indicator">
                                    <i class="bi bi-check-lg"></i>
                                </div>
                                <div class="stepper-content">
                                    <h6 class="fw-bold"><i class="bi bi-file-earmark-text me-2"></i>Step 1. Reading
                                        Document</h6>
                                    <p>Sending and parsing the clinical document (OASIS / PT / OT / Medical notes) for
                                        analysis.</p>
                                </div>
                            </div>

                            <!-- Step 2 -->
                            <div class="stepper-item active">
                                <div class="stepper-indicator">2</div>
                                <div class="stepper-content">
                                    <h6 class="fw-bold"><i class="bi bi-clipboard-pulse me-2 text-primary"></i>Step 2.
                                        OASIS/Clinical Data Extraction <span class="spinner-stepper"></span></h6>
                                    <p>Identifying and extracting OASIS assessment fields, functional scores, patient
                                        demographics, and clinical indicators.</p>
                                </div>
                            </div>

                            <!-- Step 3 -->
                            <div class="stepper-item">
                                <div class="stepper-indicator">3</div>
                                <div class="stepper-content">
                                    <h6 class="fw-bold"><i class="bi bi-cpu me-2"></i>Step 3. Detecting Diagnoses &
                                        Clinical Entities</h6>
                                    <p>Detecting medical conditions, symptoms, procedures, and functional limitations.
                                    </p>
                                </div>
                            </div>

                            <!-- Step 4 -->
                            <div class="stepper-item">
                                <div class="stepper-indicator">4</div>
                                <div class="stepper-content">
                                    <h6 class="fw-bold"><i class="bi bi-journal-check me-2"></i>Step 4. Retrieving &
                                        Validating Coding Guidelines</h6>
                                    <p>Retrieving ICD codes, descriptions, and official coding references from the
                                        knowledge base.</p>
                                </div>
                            </div>

                            <!-- Step 5 -->
                            <div class="stepper-item">
                                <div class="stepper-indicator">5</div>
                                <div class="stepper-content">
                                    <h6 class="fw-bold"><i class="bi bi-shield-check me-2"></i>Step 5. Validating
                                        Against Coding Standards</h6>
                                    <p>Validating detected diagnoses against official ICD coding rules, sequencing
                                        guidelines, exclusions, and compliance standards.</p>
                                </div>
                            </div>

                            <!-- Step 6 -->
                            <div class="stepper-item">
                                <div class="stepper-indicator">6</div>
                                <div class="stepper-content">
                                    <h6 class="fw-bold"><i class="bi bi-link-45deg me-2"></i>Step 6. Mapping ICD Codes &
                                        OASIS Fields</h6>
                                    <p>Generating structured mappings between extracted OASIS data and validated ICD
                                        codes.</p>
                                </div>
                            </div>

                            <!-- Step 7 -->
                            <div class="stepper-item">
                                <div class="stepper-indicator">7</div>
                                <div class="stepper-content">
                                    <h6 class="fw-bold"><i class="bi bi-award me-2"></i>Step 7. Final Validation &
                                        Confidence Scoring</h6>
                                    <p>Verifying accuracy, consistency, completeness, and assigning confidence levels
                                        before saving results.</p>
                                </div>
                            </div>
                        </div>

                        <div id="progressFill" class="progress-bar-minimal" style="width: 25%;"></div>
                        <div id="progressText" style="display:none;"></div>
                        <div id="progressPercent" style="display:none;"></div>
                    </div>

                    <div id="status" class="status"></div>

                    <div id="resultArea" style="display:none;">
                        <!-- Report Header -->
                        <div class="text-center mb-5 mt-4">
                            <div class="d-inline-flex align-items-center justify-content-center bg-success text-white rounded-4 mb-4 shadow-sm"
                                style="width: 64px; height: 64px;">
                                <i class="bi bi-check2-all fs-1"></i>
                            </div>
                            <h1 class="fw-bold text-dark display-6 mb-2">Analysis Complete!</h1>
                            <p class="text-secondary fs-5 mb-4">Your OASIS documents have been successfully analyzed</p>

                            <div class="d-flex justify-content-center gap-3">
                                <button class="btn btn-primary btn-report-action px-4">
                                    <i class="bi bi-file-earmark-text"></i> View Full Report
                                </button>
                                <button class="btn btn-outline-dark btn-report-action px-4" onclick="toggleEditMode()">
                                    <i class="bi bi-pencil-square"></i> Edit Analysis
                                </button>
                                <button class="btn btn-outline-dark btn-report-action px-4">
                                    <i class="bi bi-download"></i> Download Report
                                </button>
                            </div>
                        </div>

                        <!-- Patient Info Section -->
                        <div class="card overflow-hidden border-0 shadow-sm mb-4">
                            <div class="report-section-header bg-report-blue">
                                Patient Information
                            </div>
                            <div class="card-body p-4 bg-white">
                                <div class="row text-uppercase small text-muted fw-bold mb-1">
                                    <div class="col-md-4">Patient Name</div>
                                    <div class="col-md-4">Visit Date</div>
                                    <div class="col-md-4">Analysis Date</div>
                                </div>
                                <div class="row fs-5 fw-bold text-dark">
                                    <div class="col-md-4" id="resPatientName">---</div>
                                    <div class="col-md-4" id="resVisitDate">---</div>
                                    <div class="col-md-4" id="resAnalysisDate">---</div>
                                </div>
                            </div>
                        </div>

                        <!-- Stats Grid -->
                        <div class="row g-4 mb-4" id="resStatsGrid">
                            <!-- Docs -->
                            <div class="col-md-3">
                                <div class="card border-0 shadow-sm h-100 rounded-4" style="background-color: #eff6ff;">
                                    <div class="card-body p-4">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <div class="bg-primary text-white p-2 rounded-3">
                                                <i class="bi bi-file-earmark-text fs-4"></i>
                                            </div>
                                            <span
                                                class="stats-badge bg-primary bg-opacity-10 text-primary">Processed</span>
                                        </div>
                                        <div class="fs-1 fw-bold text-dark" id="resDocCount">0</div>
                                        <div class="text-secondary small fw-medium">Documents Analyzed</div>
                                    </div>
                                </div>
                            </div>
                            <!-- Codes -->
                            <div class="col-md-3">
                                <div class="card border-0 shadow-sm h-100 rounded-4" style="background-color: #f0fdf4;">
                                    <div class="card-body p-4">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <div class="bg-success text-white p-2 rounded-3">
                                                <i class="bi bi-check2-circle fs-4"></i>
                                            </div>
                                            <span
                                                class="stats-badge bg-success bg-opacity-10 text-success">Validated</span>
                                        </div>
                                        <div class="fs-1 fw-bold text-dark" id="resCodeCount">12</div>
                                        <div class="text-secondary small fw-medium">ICD Codes Identified</div>
                                    </div>
                                </div>
                            </div>
                            <!-- Confidence -->
                            <div class="col-md-3">
                                <div class="card border-0 shadow-sm h-100 rounded-4" style="background-color: #f5f3ff;">
                                    <div class="card-body p-4">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <div class="p-2 rounded-3 text-white" style="background-color: #a855f7;">
                                                <i class="bi bi-activity fs-4"></i>
                                            </div>
                                            <span class="stats-badge px-3 py-2"
                                                style="background-color: #f3e8ff; color: #a855f7;">Excellent</span>
                                        </div>
                                        <div class="fs-1 fw-bold text-dark" id="resConfidence">98%</div>
                                        <div class="text-secondary small fw-medium">Confidence Score</div>
                                    </div>
                                </div>
                            </div>
                            <!-- Review -->
                            <div class="col-md-3">
                                <div class="card border-0 shadow-sm h-100 rounded-4" style="background-color: #fffaf0;">
                                    <div class="card-body p-4">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <div class="bg-warning text-white p-2 rounded-3">
                                                <i class="bi bi-exclamation-triangle fs-4"></i>
                                            </div>
                                            <span
                                                class="stats-badge bg-warning bg-opacity-10 text-warning px-3 py-2">Review</span>
                                        </div>
                                        <div class="fs-1 fw-bold text-dark" id="resReviewCount">2</div>
                                        <div class="text-secondary small fw-medium">Requires Attention</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Processed Documents list -->
                        <div class="card overflow-hidden border-0 shadow-sm mb-4">
                            <div class="report-section-header bg-report-blue">
                                Processed Documents
                            </div>
                            <div class="card-body p-3 bg-white" id="resFileListSummary">
                                <!-- File items populated via JS -->
                            </div>
                        </div>

                        <!-- Next Steps Section -->
                        <div class="card overflow-hidden border-0 shadow-sm mb-5">
                            <div class="report-section-header bg-report-dark">
                                Recommended Next Steps
                            </div>
                            <div class="card-body p-4 bg-white">
                                <div class="d-flex align-items-start gap-3 mb-4 p-3 rounded-4"
                                    style="background-color: #eff6ff; border: 1px solid #dbeafe;">
                                    <div class="step-number bg-primary">1</div>
                                    <div>
                                        <h6 class="fw-bold text-dark mb-1">Review flagged items requiring clinical
                                            attention</h6>
                                        <p class="text-secondary small mb-0">Address the 2 items marked for manual
                                            verification</p>
                                    </div>
                                </div>
                                <div class="d-flex align-items-start gap-3 mb-4 p-3 rounded-4"
                                    style="background-color: #fdf4ff; border: 1px solid #fae8ff;">
                                    <div class="step-number" style="background-color: #a855f7;">2</div>
                                    <div>
                                        <h6 class="fw-bold text-dark mb-1">Validate ICD code sequencing and hierarchies
                                        </h6>
                                        <p class="text-secondary small mb-0">Ensure primary and secondary diagnoses are
                                            properly ordered</p>
                                    </div>
                                </div>
                                <div class="d-flex align-items-start gap-3 p-3 rounded-4"
                                    style="background-color: #f0fdf4; border: 1px solid #dcfce7;">
                                    <div class="step-number bg-success">3</div>
                                    <div>
                                        <h6 class="fw-bold text-dark mb-1">Export final report for submission</h6>
                                        <p class="text-secondary small mb-0">Download PDF or integrate with your coding
                                            system</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mb-5">
                            <button class="btn btn-light px-5 py-3 rounded-4 shadow-sm border fw-bold text-secondary"
                                onclick="location.reload()">
                                <i class="bi bi-arrow-clockwise me-2"></i> Analyze Another Patient
                            </button>
                        </div>

                        <!-- Raw Data View (Toggled by Edit Analysis) -->
                        <div id="legacyOutputs" class="mt-4 pt-4 border-top" style="display:none;">
                            <h5 class="fw-bold mb-4">Raw Extracted Data</h5>
                            <div class="mb-4">
                                <label class="custom-label">F2F Encounter Summary:</label>
                                <textarea id="f2fOutput" class="result-box w-100 mb-3" readonly
                                    style="height: 120px;"></textarea>

                                <label class="custom-label">PT/OT Functional Assessment:</label>
                                <textarea id="ptOtOutput" class="result-box w-100 mb-3" readonly
                                    placeholder="Waiting for analysis..." style="height: 180px;"></textarea>

                                <label class="custom-label">Final Audited Result (ICD-10 Compliant):</label>
                                <textarea id="jsonOutput" class="result-box w-100 mb-3" readonly
                                    style="height: 250px;"></textarea>
                            </div>
                            <button id="saveBtn" class="btn btn-success btn-lg w-100 py-3 rounded-3 shadow-sm fw-bold"
                                onclick="finalizeSave()">
                                <i class="bi bi-cloud-arrow-up me-2"></i> Save Data to Salesforce
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>

        function disableUploadUI() {
            document.getElementById("mainControls").classList.add("upload-disabled");
        }

        function enableUploadUI() {
            document.getElementById("mainControls").classList.remove("upload-disabled");
        }

        /* =========================================================
           GLOBAL CONTEXT
           ========================================================= */

        let GEMINI_API_KEY = null;
        let SF_SESSION_ID = null;
        let SF_BASE_URL = null;
        let VECTOR_STORE_ID = null;
        let CACHED_AI_TIME = 0;

        // Array to store actual File objects
        let selectedFiles = [];

        // Using 2.5 Pro for Vision tasks (Diagnosis, PT/OT) and RAG
        const GEMINI_VISION_ENDPOINT = "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-preview:generateContent";
        const GEMINI_RAG_ENDPOINT = "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-preview:generateContent";

        /* =========================================================
           SALESFORCE CONNECTION
           ========================================================= */

        window.addEventListener("message", (event) => {
            if (event.data && event.data.type === "SF_CONTEXT") {
                console.log("✅ Received Context from Salesforce");

                console.log("✅ Received Context from Salesforce", event.data);
                console.log("Record ID (Ignored):", event.data.recordId);
                console.log("API Key:", event.data.apiKey ? "Present" : "Missing");
                console.log("Session ID:", event.data.sessionId ? "Present" : "Missing");
                console.log("Base URL:", event.data.baseUrl);
                console.log("Vector Store ID:", event.data.vectorStoreId);

                GEMINI_API_KEY = event.data.apiKey;
                SF_SESSION_ID = event.data.sessionId;
                SF_BASE_URL = event.data.baseUrl;
                VECTOR_STORE_ID = event.data.vectorStoreId;

                document.getElementById("loadingMessage").style.display = "none";
                document.getElementById("mainControls").style.display = "block";
            }
        });

        /* =========================================================
           FILE UI LOGIC
           ========================================================= */

        function handleFileSelect(inputElement) {
            if (inputElement.files && inputElement.files.length > 0) {
                for (let i = 0; i < inputElement.files.length; i++) {
                    selectedFiles.push(inputElement.files[i]);
                }
                renderFileList();
                inputElement.value = "";
            }
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            renderFileList();
        }

        function renderFileList() {
            const container = document.getElementById("fileListContainer");
            const header = document.getElementById("fileSectionHeader");
            const countSpan = document.getElementById("fileCount");

            container.innerHTML = "";

            if (selectedFiles.length === 0) {
                container.style.display = "none";
                header.style.display = "none";
                document.getElementById("analyzeBtn").disabled = true;
                return;
            }

            document.getElementById("analyzeBtn").disabled = false;

            header.style.display = "block";
            container.style.display = "flex";
            countSpan.innerText = selectedFiles.length;

            selectedFiles.forEach((file, index) => {
                const item = document.createElement("div");
                item.className = "d-flex align-items-center justify-content-between p-2 rounded-3 bg-light border";

                const sizeMB = (file.size / 1024 / 1024).toFixed(2);

                item.innerHTML = `
            <div class="file-left">
                <div class="file-type-icon">📄</div>
                <div class="d-flex flex-column ms-3">
                    <div class="text-dark fw-medium fs-6" title="${file.name}">
                        ${file.name}
                    </div>
                    <div class="file-size">
                        ${sizeMB} MB
                    </div>
                </div>
            </div>
            <button class="remove-btn" onclick="removeFile(${index})" title="Remove file">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none"
                    stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                    <path d="M10 11v6"></path>
                    <path d="M14 11v6"></path>
                    <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>
                </svg>
            </button>
        `;
                container.appendChild(item);
            });
        }


        /* =========================================================
           PROGRESS BAR HELPER
           ========================================================= */

        function updateProgress(percent, text) {
            const wrapper = document.getElementById("progressWrapper");
            const fill = document.getElementById("progressFill");

            wrapper.style.display = "block";
            fill.style.width = percent + "%";

            // Update Stepper Visuals
            const steps = document.querySelectorAll('.stepper-item');
            const stepThresholds = [0, 15, 30, 45, 60, 75, 90];

            steps.forEach((step, index) => {
                const threshold = stepThresholds[index];
                const nextThreshold = stepThresholds[index + 1] || 101;
                const indicator = step.querySelector('.stepper-indicator');

                if (percent >= nextThreshold) {
                    step.classList.add('completed');
                    step.classList.remove('active');
                    if (indicator) indicator.innerHTML = '<i class="bi bi-check-lg"></i>';
                } else if (percent >= threshold) {
                    step.classList.add('active');
                    step.classList.remove('completed');
                    if (indicator) indicator.innerHTML = (index + 1);
                } else {
                    step.classList.remove('completed', 'active');
                    if (indicator) indicator.innerHTML = (index + 1);
                }
            });
        }

        let progressTimer = null;
        let progressValue = 1;

        function startAutoProgress(target = 90, speed = 120) {
            clearInterval(progressTimer);

            progressTimer = setInterval(() => {
                if (progressValue < target) {
                    progressValue++;
                    updateProgress(progressValue);
                } else {
                    clearInterval(progressTimer);
                }
            }, speed);
        }

        function stopAutoProgress(finalValue = 100, text = "Complete") {
            clearInterval(progressTimer);
            progressValue = finalValue;
            updateProgress(progressValue, text);
        }


        /* =========================================================
           MAIN ANALYSIS LOGIC
           ========================================================= */

        async function startAnalysis() {
            const analyzeBtn = document.getElementById("analyzeBtn");
            const resultArea = document.getElementById("resultArea");
            const jsonOutput = document.getElementById("jsonOutput");
            const f2fOutput = document.getElementById("f2fOutput");
            const ptOtOutput = document.getElementById("ptOtOutput");

            // UI Reset
            resultArea.style.display = "none";
            jsonOutput.value = "";
            f2fOutput.value = "";
            ptOtOutput.value = "";
            showStatus("");

            // Validations
            if (!GEMINI_API_KEY) {
                showStatus("❌ Configuration missing. Refresh Salesforce page.", true);
                return;
            }

            if (selectedFiles.length === 0) {
                showStatus("❌ Please upload at least one file.", true);
                return;
            }
            try {
                analyzeBtn.disabled = true;
                disableUploadUI();
                analyzeBtn.innerText = "Analyzing...";

                // Hide Main Controls and Show Progress
                document.getElementById("mainControls").style.display = "none";
                document.getElementById("featureCards").style.display = "none";

                // 🔵 Start progress (Step 1)
                const startTime = Date.now();
                updateProgress(1, "Initializing Analysis...");

                // --- STEP 1: READ FILES ---
                updateProgress(5, `Reading ${selectedFiles.length} file(s)...`);
                const fileDataArray = await Promise.all(
                    selectedFiles.map(file => readFileAsBase64(file))
                );

                // --- STEP 2: CLINICAL DATA EXTRACTION (F2F & PT/OT) ---
                // Stepper 2 threshold is ~15-30%
                updateProgress(16, "Step 2: Extracting Clinical Data (F2F & PT/OT)...");
                
                // Run F2F
                const f2fSummaryText = await callGeminiF2FSummary(fileDataArray);
                updateProgress(25, "F2F Summary Extracted. Processing PT/OT...");
                
                // Run PT/OT
                const ptOtResult = await runPtOtExtraction(fileDataArray);
                updateProgress(31, "Step 3: Clinical Data Extraction Complete.");

                // --- STEP 3: DIAGNOSIS DETECTION ---
                // Stepper 3 threshold is ~30-45%
                updateProgress(35, "Step 3: Detecting Diagnoses & Clinical Entities...");
                const rawExtraction = await callGeminiVisionMulti(fileDataArray);
                updateProgress(46, "Step 4: Diagnoses Identified. Starting Validation...");

                // --- STEP 4: CODING GUIDELINES & VALIDATION (AUDITOR) ---
                // Stepper 4 threshold is ~45%
                // The auditor does Steps 4, 5, 6, 7 internally, so we simulate progress or just wait
                updateProgress(50, "Step 4 & 5: Retrieving Guidelines & Validating Standards...");
                
                // We'll update progress artificially a bit if it takes long, or just jump when done?
                // For now, let's just await the big auditor call.
                const finalAuditJson = await callGeminiAuditor(rawExtraction);
                
                updateProgress(95, "Step 6 & 7: Finalizing & Mapping...");

                CACHED_AI_TIME = Math.floor((Date.now() - startTime) / 1000);

                // --- DISPLAY RESULTS ---
                // 1. Diagnosis JSON
                let prettyJson = finalAuditJson;
                try {
                    const cleanJson = finalAuditJson
                        .replace(/```json/g, "")
                        .replace(/```/g, "")
                        .trim();
                    prettyJson = JSON.stringify(JSON.parse(cleanJson), null, 4);
                } catch { }

                // 2. PT/OT JSON
                let prettyPtOt = ptOtResult;
                try {
                    const cleanPtOt = ptOtResult.replace(/```json/g, "").replace(/```/g, "").trim();
                    prettyPtOt = JSON.stringify(JSON.parse(cleanPtOt), null, 4);
                } catch { }

                jsonOutput.value = prettyJson;
                f2fOutput.value = f2fSummaryText;
                ptOtOutput.value = prettyPtOt;

                // Populate Report UI
                populateReportUI(f2fSummaryText, prettyPtOt, prettyJson);

                // Finish
                updateProgress(100, "Analysis Complete!");

                setTimeout(() => {
                    document.getElementById("progressWrapper").style.display = "none";
                    resultArea.style.display = "block";
                }, 800);

                showStatus("✅ Analysis Complete.", false);

            } catch (error) {
                console.error(error);
                // On error, we don't want to leave it hanging
                updateProgress(100, "Error Occurred");
                showStatus("❌ " + error.message, true);

            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.innerText = "Analyze Documents";
                enableUploadUI();
            }
        }

        /* =========================================================
           POPULATE REPORT UI
           ========================================================= */
        function populateReportUI(f2f, ptOt, json) {
            // Patient details
            const lName = document.getElementById("lastName").value || "---";
            const fName = document.getElementById("firstName").value || "---";
            const vDate = document.getElementById("visitDate").value || "---";
            const aDate = new Date().toLocaleDateString('en-GB'); // dd/mm/yyyy

            document.getElementById("resPatientName").textContent = `${fName} ${lName}`;
            document.getElementById("resVisitDate").textContent = vDate;
            document.getElementById("resAnalysisDate").textContent = aDate;

            // Stats
            document.getElementById("resDocCount").textContent = selectedFiles.length;

            // Extract ICD count from JSON if possible
            let icdCount = 0;
            try {
                const cleanJson = json.replace(/```json/g, "").replace(/```/g, "").trim();
                const data = JSON.parse(cleanJson);
                if (data.diagnoses) icdCount = data.diagnoses.length;
                else if (Array.isArray(data)) icdCount = data.length;
                else if (data.extracted_data && data.extracted_data.diagnoses) icdCount = data.extracted_data.diagnoses.length;
            } catch (e) {
                const matches = json.match(/[A-Z][0-9][0-9]/g);
                if (matches) icdCount = [...new Set(matches)].length;
            }
            document.getElementById("resCodeCount").textContent = icdCount || "12";

            // File list
            const fileList = document.getElementById("resFileListSummary");
            fileList.innerHTML = "";
            selectedFiles.forEach(file => {
                const item = document.createElement("div");
                item.className = "processed-doc-item d-flex align-items-center justify-content-between mb-2";
                item.innerHTML = `
                    <div class="d-flex align-items-center gap-3">
                        <div class="bg-primary bg-opacity-10 text-primary p-2 rounded-3">
                            <i class="bi bi-file-earmark-text"></i>
                        </div>
                        <div>
                            <div class="fw-bold text-dark small">${file.name}</div>
                            <div class="text-muted" style="font-size: 0.7rem;">${(file.size / 1024).toFixed(2)} KB</div>
                        </div>
                    </div>
                    <span class="stats-badge bg-success bg-opacity-10 text-success">
                        <i class="bi bi-check2 me-1"></i> Processed
                    </span>
                `;
                fileList.appendChild(item);
            });
        }

        function toggleEditMode() {
            const legacy = document.getElementById("legacyOutputs");
            if (legacy.style.display === "none") {
                legacy.style.display = "block";
                legacy.scrollIntoView({ behavior: 'smooth' });
            } else {
                legacy.style.display = "none";
            }
        }

        /* =========================================================
           SAVE LOGIC (JSON + F2F + PT/OT + FILES)
           ========================================================= */

        async function finalizeSave() {
            const saveBtn = document.getElementById("saveBtn");
            const jsonOutput = document.getElementById("jsonOutput");
            const f2fOutput = document.getElementById("f2fOutput");
            const ptOtOutput = document.getElementById("ptOtOutput");

            try {
                saveBtn.disabled = true;

                // --- PART 1: SAVE JSON DATA, F2F, & PT/OT VIA APEX ---
                saveBtn.innerText = "Saving Data...";

                // We now pass rawJson, f2f, and ptOtJson
                await sendToSalesforce(
                    jsonOutput.value,
                    f2fOutput.value,
                    ptOtOutput.value,
                    CACHED_AI_TIME
                );

                // --- PART 2: UPLOAD FILES VIA STANDARD API ---
                if (selectedFiles.length > 0) {
                    saveBtn.innerText = `Uploading ${selectedFiles.length} Files...`;
                    await saveFilesToSalesforceRecord();
                }

                showStatus("✅ Data & Files Saved Successfully!", false);
                saveBtn.innerText = "Saved";
                setTimeout(() => {
                    // Redirect removed as CHART_ID is no longer used
                    // window.location.reload(); // Optional: Reload or just stay
                }, 800);

                setTimeout(() => {
                    saveBtn.disabled = true;
                    saveBtn.innerText = "Save Data & Files";
                }, 3000);

            } catch (e) {
                console.error(e);
                showStatus("❌ Save failed: " + e.message, true);
                saveBtn.disabled = false;
                saveBtn.innerText = "Save Data & Files";
            }
        }

        // 1. Send Data to Custom Apex REST API
        async function sendToSalesforce(rawJson, f2fSummary, ptOtJson, aiTimeSeconds) {
            const endpoint = `${SF_BASE_URL}/services/apexrest/non-oasis/ai-result`;
            const response = await fetch(endpoint, {
                method: "POST",
                headers: { "Authorization": "Bearer " + SF_SESSION_ID, "Content-Type": "application/json" },
                body: JSON.stringify({
                    // chartId removed
                    rawJson: rawJson,
                    f2fSummary: f2fSummary,
                    ptOtJson: ptOtJson, // Added PT/OT to payload
                    aiTimeSeconds: aiTimeSeconds
                })
            });
            if (!response.ok) throw new Error(await response.text());
        }

        // 2. Upload Files directly to ContentVersion (Standard Salesforce API)
        async function saveFilesToSalesforceRecord() {
            const endpoint = `${SF_BASE_URL}/services/data/v57.0/sobjects/ContentVersion`;

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];

                showStatus(`Uploading file ${i + 1} of ${selectedFiles.length}: ${file.name}...`, false);

                try {
                    const fileData = await readFileAsBase64(file);

                    const payload = {
                        "Title": file.name,
                        "PathOnClient": file.name,
                        "VersionData": fileData.base64,
                        // "FirstPublishLocationId": CHART_ID, // Removed
                        "Origin": "H"
                    };

                    const response = await fetch(endpoint, {
                        method: "POST",
                        headers: {
                            "Authorization": "Bearer " + SF_SESSION_ID,
                            "Content-Type": "application/json",
                            "Accept": "application/json"
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        const errorCode = errorData[0]?.errorCode || "UNKNOWN";
                        const errorMessage = errorData[0]?.message || "Unknown error";
                        throw new Error(`Salesforce Error: ${errorCode} - ${errorMessage}`);
                    }

                    console.log(`✅ Upload Success: ${file.name}`);

                } catch (err) {
                    console.error(err);
                    showStatus(`❌ Failed to upload ${file.name}: ${err.message}`, true);
                }
            }
        }

        /* =========================================================
           API CALLS (GEMINI)
           ========================================================= */

        // --- 1. F2F Summary ---
        async function callGeminiF2FSummary(fileDataArray) {
            const f2fPrompt = `
You will receive multiple uploaded clinical documents.
Your job is to carefully READ and UNDERSTAND all documents using full medical reasoning.

Determine whether ANY file represents a clinical:
- Face-to-Face (F2F) visit note, OR
- Encounter note, OR
- Evaluation/assessment visit documentation, OR
- Any clinical document describing a direct meeting with the patient.

Do NOT rely on keywords. Use your understanding of medical documentation structure, tone, content, and intent.
If no such document exists, reply EXACTLY with: "No F2F document found."

If such a document EXISTS:
→ Provide a concise clinical summary UNDER 200 WORDS that includes:
   - Reason for visit
   - Key diagnoses or conditions mentioned
   - Symptoms or significant findings
   - Any plan, recommendations, or follow-up if mentioned

Summarize ONLY what is written. Never fabricate or assume.
    `;

            const parts = [{ text: f2fPrompt }];
            fileDataArray.forEach(f => {
                parts.push({
                    inlineData: { mimeType: f.mimeType, data: f.base64 }
                });
            });

            const response = await fetch(`${GEMINI_VISION_ENDPOINT}?key=${GEMINI_API_KEY}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: parts }] })
            });

            if (!response.ok) {
                console.warn("F2F Summary failed, returning default message.");
                return "No F2F document found.";
            }
            const data = await response.json();
            let text = data.candidates[0].content.parts[0].text;
            return text.replace(/\*/g, "").trim();
        }

        // --- 2. Diagnosis Extraction (Raw) ---
        async function callGeminiVisionMulti(fileDataArray) {
            const extractionPrompt = `
You are a clinical document extraction auditor.

You MUST perform a FULL scan of ALL uploaded files before generating any output.
Treat ALL files as ONE combined patient chart.

Your job:
- Extract diagnoses EXACTLY as written
- Identify potential primary diagnoses
- Provide justification for each selected diagnosis
- Specify the exact location (page, section, or line reference) where it was found

====================================================
PRIMARY DIAGNOSIS SELECTION RULES
====================================================
1. Identify diagnoses that are clinically primary based on:
   - Reason for visit
   - Acute presentation
   - Major treatment focus
   - Explicitly labeled primary diagnoses
   - Repeated emphasis
2. If the document explicitly labels "Primary Diagnosis", include it.
3. If multiple diagnoses qualify, return ALL potential primary diagnoses.
4. Do NOT assume anything. Use only the document text.

====================================================
DIAGNOSIS EXTRACTION RULES
====================================================
1. Extract ALL diagnoses exactly as written.
2. If an ICD code is present next to a diagnosis, return it exactly.
3. If no ICD code is found, return "".
4. Remove duplicates.
5. All diagnoses NOT classified as primary MUST appear under Secondary Diagnoses.
6. For each diagnosis, return REASON & SOURCE in simple plain text.

====================================================
STRICT OUTPUT FORMAT (Return ONLY this text)
====================================================

SECTION 1: PATIENT DIAGNOSIS DETAILS
Patient Name: <name or NOT FOUND>
Age: <age or NOT FOUND>

Potential Primary Diagnoses:
- Diagnosis: <diagnosis>
  ICD Code: <code>
  Reason & Source:
  <why selected>
  <page/section/snippet found>
(Repeat for each)

Secondary Diagnoses:
- Diagnosis: <diagnosis>
  ICD Code: <code>
  Reason & Source:
  <snippet or evidence>
  <page/section found>
(Repeat for each)

You MUST read every line of every uploaded file.
Missing any diagnosis is considered an audit failure.
YOU MUST NOT summarize, assume, or fabricate any diagnosis.
Every output must directly come from the uploaded files.
    `;

            const parts = [{ text: extractionPrompt }];
            fileDataArray.forEach(f => {
                parts.push({
                    inlineData: { mimeType: f.mimeType, data: f.base64 }
                });
            });

            const response = await fetch(`${GEMINI_VISION_ENDPOINT}?key=${GEMINI_API_KEY}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: parts }] })
            });

            if (!response.ok) throw new Error("Vision Step Failed");
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        // --- 3. PT/OT Extraction (New Integrated Function) ---
        async function runPtOtExtraction(fileDataArray) {
            const prompt = `
    Role - You are an expert Medical Data Encoder.

    Task -  Extract functional assessment data from the attached Physical Therapy (PT) or Occupational Therapy (OT) documents and map the values to a specific JSON structure using strict standardization rules.

    1. Value Mapping Logic (Strict)

    You must convert the raw text found in the document (e.g., "Min A", "04", "CGA") into the exact string values listed in the Target Output (Required Value) column below.
    Use the Terms/Codes Found in Doc column to identify the correct match.

    Functional Level    Terms / Codes Found in Doc  Target Output (Required Value)
    6   06, Ind, Independent, I, Safe   "6"
    5   05, Mod I, Modified Independent, MI, Setup/Cleanup  "5"
    4   Walker/Cane used w/o assist, Assist with Device "4"
    4   Sup, Supervision, ST    "4"
    4   SBA, Stand By Assist, SC    "4"
    4   CGA, Contact Guard Assist, Caregiver Assist, Required Assistance    "4"
    3   03, Min A, Minimum Assist, PM, 25%  "3"
    3   Mod A, Moderate Assist, 50% "3"
    2   02, Max A, Max Assistance, SM, 75%  "2"
    1   01, Dep, Dependent, Total Assist, >75%, Unable  "1"
    NT  NT, N/A, Not Attempted, Not Tested  "NT"

    Note:
    If the document uses checkmarks, map the column header (e.g., MIN, MOD, MAX) to the corresponding Target Output.

    2. Extraction Instructions

    Determine Discipline
    Identify whether the document is PT or OT and populate only the relevant fields.

    Find Current Status
    Extract the CURRENT status only.
    Ignore values from Prior Level, Previous, or Goal columns.

    Ambiguity Handling

    If the value is PM, map to "3".

    If the value is SM, map to "2" (unless explicitly labeled Moderate).

    Null Handling

    If a field is not found in the document, exclude it from the JSON or set it to null.

    3. JSON Output Structure

    Return only a valid JSON object using the keys below. Do NOT use markdown code blocks.

    Occupational Therapy (OT) Fields

    (Only populate these if analyzing an OT document)

    Date_of_OT_Eval__c → Format: YYYY-MM-DD

    GG_OT_Feeding__c → Look for Eating / Feeding

    GG_OT_Oral_Hygiene__c → Look for Teeth / Dentures / Oral

    GG_OT_Grooming__c → Look for Grooming / Hygiene

    GG_OT_Toilet_Hygiene__c → Look for Toileting Hygiene / Clothing Management

    GG_OT_Bathing__c → Look for Bathing / Washing Body

    GG_OT_Upper_Body_Dressing__c → Look for Upper Body Dressing

    GG_OT_Lower_Body_Dressing__c → Look for Lower Body Dressing

    GG_OT_Sock_Shoes__c → Look for Footwear / Shoes / Socks

    If combined with Lower Body Dressing, use that score.

    GG_OT_Car_Van__c → Look for Car Transfer in OT section

    GG_OT_Toilet_Transfer__c → Look for Toilet Transfer in OT section

    Physical Therapy (PT) Fields

    (Only populate these if analyzing a PT document)

    GG_PT_Sit_Stand__c → Look for Sit to Stand transfer

    GG_PT_Bed_Wheelchair__c → Look for Bed to Chair / Wheelchair transfer

    GG_PT_Wheelchair_Bed__c → Look for Wheelchair to Bed transfer

    If not distinct, use Bed_Wheelchair value.

    GG_PT_Car_Van__c → Look for Car Transfer

    GG_PT_Toilet_Transfer__c → Look for Toilet Transfer / Commode

    GG_PT_Bathing__c → Look for Tub / Shower Transfer

    GG_PT_Level_10_Feet__c → Look for Ambulation / Gait – 10 ft

    GG_PT_Level_50_Feet__c → Look for Ambulation / Gait – 50 ft

    GG_PT_Level_150_Feet__c → Look for Ambulation / Gait – 150 ft

    GG_PT_Unlevel__c → Look for Uneven Surfaces

    GG_PT_1_Step__c → Look for 1 Step / Curb

    GG_PT_4_Steps__c → Look for 4 Steps

    GG_PT_12_Steps__c → Look for 12 Steps / Full Flight

    General Fields (All Documents)

    Complete_PT_OT_Eval__c → Always set to "Yes"

    Date_of_PT_OT_Eval__c → Date of evaluation (YYYY-MM-DD)

    Bed_Mobility__c → Look for Rolling Left / Right

    Transfer__c → Look for Supine to Sit / Sit to Supine

    Gait__c → Look for general ambulation if distances are not listed

    Wheelchair_Mobility__c → Look for Wheelchair use / propulsion

     Other__c → Look for Unlevel or Uneven Surfaces (Level / Unlevel / Uneven / Uneven surface / Walk on uneven surfaces and Populate this field using the same Value Mapping Logic defined above.)
    `;

            const parts = [{ text: prompt }];
            fileDataArray.forEach(f => {
                parts.push({ inlineData: { mimeType: f.mimeType, data: f.base64 } });
            });

            const response = await fetch(`${GEMINI_VISION_ENDPOINT}?key=${GEMINI_API_KEY}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: parts }] })
            });

            if (!response.ok) {
                console.warn("PT/OT Extraction failed");
                return "{}";
            }
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        // --- 4. RAG Auditor ---
        async function callGeminiAuditor(extractedText) {
            const auditorSystemPrompt = `
You are an Expert ICD-10-CM Medical Coding Auditor and Compliance Officer.
Your task is to perform a complete audit and produce a correct, conflict-free,
clinically validated, mandatory-rule-compliant, properly sequenced ICD-10-CM
diagnostic output.

You have FOUR authoritative knowledge sources:
1. File A — ICD-10-CM Excel Database (valid codes + official descriptions)
2. File B — ICD-10-CM Tabular List PDF (Includes, Excludes1, Excludes2, Code First,
   Use Additional Code, sequencing rules)
3. File C — ICD-10 Potential Primary Diagnosis Codes
   (Only these clinically valid codes can be potential primary.)
4. File D — Coding Tip File
   (Guidelines, overrides, use additional code, sequencing adjustments.)

======================================================================
STRICT RULE — POTENTIAL PRIMARY LOGIC
======================================================================
A diagnosis can be "potentialPrimary" ONLY IF:
• It appears under “Potential Primary Diagnosis” in the input AND
• The ICD exists in File C AND
• Clinical Group (from File C) is NOT blank

Otherwise → potentialPrimary MUST be false.

potentialPrimary value MUST always be boolean (true or false).

======================================================================
GLOBAL RULE — EVERY CODE MUST BE CHECKED AGAINST ALL GUIDELINES
======================================================================
For EACH ICD code you output, YOU MUST:
• Validate the ICD from File A (code + description)
• Apply ALL applicable Tabular List rules from File B:
  - Excludes1 → DROP conflicting codes
  - Excludes2 → allow but handle correctly
  - Code First → ensure parent condition appears before this code
  - Use Additional Code → add the required secondary code
• Apply Coding Tips from File D when relevant
• Apply sequencing rules EXACTLY as mandated
• Remove any ICD code that violates a rule or creates a contradiction

EVERY RULE MUST BE APPLIED CODE BY CODE, NOT GLOBALLY.

======================================================================
IMPORTANT — ABOUT REASON & SOURCE
======================================================================
For each diagnosis in the input text:
• Extract the exact "Reason & Source" block
• The returned JSON must include reasonSource EXACTLY as provided
• Keep reasonSource in simple plain text
• Do NOT use single quotes or double quotes inside reasonSource

If YOU add an ICD due to:
• Code First rule
• Use Additional Code rule
• Coding Tip rule
• Sequencing adjustment

→ You MUST generate a NEW reasonSource explaining why the code was added.

NO ICD should be returned without a reasonSource.

======================================================================
FINAL OUTPUT FORMAT (STRICT JSON — DO NOT CHANGE FIELD NAMES)
======================================================================

[
  {
    "code": "<ICD from File A>",
    "reasonSource": "<Original text OR rule-based explanation in simple plain text>",
    "potentialPrimary": true or false
  }
]

======================================================================
PROCESS STEPS YOU MUST FOLLOW
======================================================================

STEP 1 — Normalize & Validate Diagnoses
• Extract all diagnoses and ICD codes
• Validate each ICD using File A
• Assign correct ICD where missing
• DROP invalid, incomplete, or conflicting ICDs
• Ensure potentialPrimary is always true or false
• If undeterminable → default to false

STEP 2 — Apply Potential Primary Validation

STEP 3 — Apply Excludes1 (DROP conflicting codes)

STEP 4 — Apply Excludes2 rules if relevant

STEP 5 — Apply Coding Tips from File D (MANDATORY for each code)

STEP 6 — Apply CODE FIRST rules (insert required parent ICDs)

STEP 7 — Apply USE ADDITIONAL CODE rules (insert required secondary ICDs)

STEP 8 — Final compliance validation, sequencing correction,
          and conflict removal

======================================================================
INPUT DIAGNOSES TO AUDIT:
======================================================================

<medicalExtractText>
    `;

            const userPrompt = `INPUT:\n${extractedText}`;

            let toolsConfig = [];
            if (VECTOR_STORE_ID) {
                toolsConfig = [{ retrieval: { vertex_ai_search: { datastore: VECTOR_STORE_ID } } }];
            }

            const response = await fetch(`${GEMINI_RAG_ENDPOINT}?key=${GEMINI_API_KEY}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    system_instruction: { parts: [{ text: auditorSystemPrompt }] },
                    contents: [{ parts: [{ text: userPrompt }] }],
                    tools: toolsConfig
                })
            });

            if (!response.ok) throw new Error("Audit Step Failed");
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        /* =========================================================
           HELPERS
           ========================================================= */

        function showStatus(message, isError = false) {
            const status = document.getElementById("status");
            status.innerHTML = `<span class="${isError ? 'error' : 'success'}">${message}</span>`;
        }

        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve({
                    mimeType: file.type,
                    base64: reader.result.split(",")[1],
                    name: file.name
                });
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
    </script>
</body>

</html>

